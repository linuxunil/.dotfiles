# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Domain-based Ansible system configuration management for macOS and Linux environments. Uses Go-task as the primary command interface with conditional dotfiles management that only symlinks configurations for installed tools.

## Key Commands

### Essential Setup
```bash
task deps                 # Install Ansible Galaxy collections (run first!)
task pkg base             # Install essential CLI tools
task pkg development      # Install development tools and languages  
task pkg gui              # Install GUI applications and desktop
task all                  # Install all domains for current machine
task dot                  # Setup dotfiles symlinks (conditional)
```

### Development Workflow
```bash
task check               # Validate Ansible playbook syntax
task dry-run             # Preview changes without applying
task clean               # Clean broken symlinks in home directory
ansible-playbook dotfiles.yml    # Standalone dotfiles management
```

## Architecture

### Domain Structure
- **base**: Essential CLI tools (git, neovim, ripgrep, fzf, starship)
- **development**: Languages (Go, Python, Zig via Mise) and dev tools (podman, zellij, lazygit)
- **gui**: Desktop apps and Hyprland environment (Linux) with catppuccin-macchiato theme

### Directory Layout
```
├── Taskfile.yml         # Go-task commands
├── site.yml             # Main Ansible playbook
├── dotfiles.yml         # Conditional dotfiles playbook
├── inventory/           # Machine configurations
│   ├── localhost.yml    # Local machine (auto-detects OS)
│   ├── linux.yml        # athena.local remote
│   └── hera.yml         # hera.local remote
├── domains/             # Domain roles
│   ├── base/            # Core CLI tools
│   ├── development/     # Dev tools & languages
│   └── gui/             # Desktop applications
└── config/              # Static dotfiles (git-managed)
    ├── nvim/            # Neovim (kickstart-based)
    ├── zellij/          # Terminal multiplexer with dev layouts
    ├── ghostty/         # Terminal emulator
    └── ...              # Other app configs
```

## Development Guidelines

### Adding Packages
1. Edit domain's `defaults/main.yml` for package lists
2. Add platform-specific packages in `vars/Darwin.yml` or `vars/RedHat.yml`
3. Test with `task dry-run` before applying

### Managing Dotfiles
- **Edit directly** in `config/` directory - all files are static and git-managed
- **Conditional linking** - only creates symlinks for installed tools
- **Update symlinks** with `task dot` after installing new tools
- **Never generate configs** - Ansible only manages symlinks, not content

### Testing Changes
```bash
task deps                # Ensure Galaxy collections installed
task check               # Validate syntax
task dry-run             # Preview changes
task pkg <domain>        # Apply specific domain
```

## Platform Notes

- **macOS**: Uses Homebrew and Cask, includes Raycast
- **Linux**: Uses DNF and Flatpak, includes full Hyprland desktop
- **Container runtime**: Podman (cross-platform)
- **Language management**: Mise for Go, Python, Zig
- **Python packages**: UV for modern Python management
- **Shell**: Zsh with Starship prompt

## Key Features

### Conditional Dotfiles
- Automatically discovers directories in `config/`
- Only symlinks configs for installed tools
- Special handling for shell files (.zshenv, .zprofile)
- Tool detection via `which` command

### Zellij Development Layouts
Pre-configured layouts in `config/zellij/layouts/`:
- Language-specific: `go-dev`, `python-dev`, `rust-dev`, `ts-dev`
- IDE-specific: `goland-dev`, `pycharm-dev`, `zed-dev`, `helix-dev`
- Special purpose: `docker-dev`, `ansible-dev`, `general-dev`

### Multi-Machine Deployment
- SSH-based remote deployment (hera ↔ athena)
- Inventory-based configuration
- OS detection for localhost
- Consistent tool stack across platforms

## Important Notes

- Always run `task deps` first for Galaxy collections
- The machines/ directory is deprecated - use inventory files
- All config files are static (git-managed), never generated by Ansible
- Domain dependencies: development and gui both require base